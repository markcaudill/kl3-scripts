#!/bin/sh
# Read Linux manual pages from Debian
# See man(1) and mandoc(1) for options

cache() {
	# fetch new/update cached new manual page
	curl --connect-timeout 3 -fsSRz"${1}" -o"${1}" "${2}" ||
		die 1 "Could not fetch/update ${1##*/}."
}

die() {
	printf '%s: %s\n' "${0##*/}" "${2}" 1>&2
	exit ${1}
}

MKDIR() {
	[ -d "${1}" ] || mkdir -p "${1}" ||
		die 1 "${1} cannot be created."
}

usage() {
	cat << EOF 1>&2
usage: ${0##*/} [-c] [-l language] [-s section] [-O options]
            [-O options] [-T output] name
EOF
	exit ${1}
}


args=$(getopt cl::s::O::T:: "${@}")
[ ${?} -eq 0 ] || usage 2

set -- ${args}

# host specific defaults
host=https://manpages.debian.org
suite=/unstable
fmt=.gz

# man(1)/mandoc(1) flags
[ -t 0 ] &&
	cflag=-a ||
	cflag=-c

while [ ${#} -ne 0 ]; do
	case "${1}"
	in
	-c)
		cflag=-c
		shift;;
	-l)
		lang=."${2}"
		shift 2;;
	-s)
		section=."${2}"
		shift 2;;
	-T)
		Tflag=-T"${2}"
		shift 2;;
	--)
		shift
		break;;
	esac
done

[ -z "${@}" ] && usage 5
# foo
name=/"${@}"
set -x
lmanpath="${LMANPATH:-${HOME}/.lman}"
MKDIR "${lmanpath}"

MANDOC="mandoc ${cflag} ${Oflag} ${Tflag}"

scheme="${host}${suite}${pkg}${name}${section}${lang}${fmt}"

file=$(find "${lmanpath}" -type f -name "${name#/}.*" |
	grep -E "${name#/}\.[1-9]$" | head -n1)
# cache hit
if [ -n "${file}" ]; then
	# XXX: update before reading
	exec ${MANDOC} "${file}"
fi

# https://.../foo.1.en.gz
url=$(curl -fsSLI "${scheme}" | grep ^Location | grep -Fv dyn.manpages |
	cut -d' ' -f2 | tr -d \\r)
[ -z "${url}" ] && die 1 "No entry for ${name#/} in the manual."

# successful lookup

man=${url##*/}
man=${man%.*}
# foo.1
man=${man%.*}

lmanpath="${lmanpath}"/man${man##*.}
MKDIR "${lmanpath}"

# ~/.lman/man1/foo.1
file="${lmanpath}"/${man}

# fetch
cache "${file}" "${url}" &&
	exec ${MANDOC} "${file}"
