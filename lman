#!/bin/sh
# Read Linux manual pages from Debian
# See man(1) and mandoc(1) for options

die() {
	printf %s\\n "${2}" 1>&2
	exit ${1}
}

usage() {
	cat << EOF 1>&2
usage: ${0##*/} [-c] [-l language] [-s section] [-O options]
            [-O options] [-T output] name
EOF
	exit ${1}
}

args=$(getopt cl::s::O::T:: "${@}")
[ ${?} -eq 0 ] || usage 2

set -- ${args}

# host specific defaults
host=https://manpages.debian.org
suite=/unstable
fmt=.gz

# man(1)/mandoc(1) flags
[ -t 0 ] &&
	cflag=-a ||
	cflag=-c

while [ ${#} -ne 0 ]; do
	case "${1}"
	in
	-c)
		cflag=-c
		shift;;
	-l)
		lang=."${2}"
		shift 2;;
	-s)
		section=."${2}"
		shift 2;;
	-T)
		Tflag=-T"${2}"
		shift 2;;
	--)
		shift
		break;;
	esac
done

[ -z "${@}" ] && usage 5

name=/"${@}"
scheme="${host}${suite}${pkg}${name}${section}${lang}${fmt}"

path=~/.cache/lman
[ -d "${path}" ] || mkdir -p "${path}" ||
	die 1 "${path} not writable."

# XXX: fetch resulting url (section/name) seperately
man="${path}"/$(printf %s "${scheme}" | sha1 -q)

# cache man page, fetch/refresh if possible otherwise read from file
curl -fLsSRz "${man}" -o "${man}" "${scheme}" || [ -e "${man}" ] ||
	die 1 "${0##*/}: No entry for ${man##*/} in the manual."

mandoc ${cflag} ${Oflag} ${Tflag} "${man}"
