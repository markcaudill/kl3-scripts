#!/bin/sh
# Build OpenBSD from source according to release(8)

set -eu

[ $(id -u) -eq 0 ]

ask() {
	printf '%s? [yN]: ' "${1}"
	read REPLY
	[ "${REPLY}" = y ]
}

build() {
	set -x
	mount -s /usr/${X:-}obj
	time make -C"${DIR}" ${@:-} 1>/dev/null
}

build_base() {
	DIR=/usr/src
	build obj build
	if ask 'run sysmerge'; then
		if ask '  diff mode'; then
			sysmerge -d
		else
			sysmerge
		fi
	fi
}

build_kernel() {
	DIR=/sys/arch/"$(machine)"/compile/GENERIC.MP
	build obj config
	build
	ask 'install kernel' && make -C"${DIR}" install
}

build_xenocara() {
	DIR=/usr/xenocara
	X=x build bootstrap obj build
}

ask 'build kernel'   && build_kernel
ask 'build base'     && build_base
ask 'build xenocara' && build_xenocara

return 0
