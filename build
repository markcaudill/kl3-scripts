#!/bin/sh
# Build OpenBSD from source according to release(8)

set -eu

[ $(id -u) -eq 0 ]

ask() {
	printf '%s? [yN]: ' "${1}"
	read REPLY
	[ "${REPLY}" = y ] || return 1
	return 0
}

build_base() {
	DIR=/usr/src
	time (
		set -x
		mount -s /usr/obj
		cd "${DIR}"
		make obj
		make build
	) 1>/dev/null
	if ask 'run sysmerge'; then
		if ask '  diff mode'; then
			sysmerge -d
		else
			sysmerge
		fi
	fi
}

build_kernel() {
	DIR=/sys/arch/"$(machine)"/compile/GENERIC.MP
	time (
		set -x
		mount -s /usr/obj
		cd "${DIR}"
		make obj
		make config
		make
	) 1>/dev/null
	ask 'install kernel' && make -C"${DIR}" install
}

build_xenocara() {
	DIR=/usr/xenocara
	time (
		set -x
		mount -s /usr/xobj
		cd "${DIR}"
		make bootstrap
		make obj
		make build
	) 1>/dev/null
}

ask 'build kernel' && build_kernel
ask 'build base' && build_base
ask 'build xenocara' && build_xenocara

return 0
