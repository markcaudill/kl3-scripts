#!/bin/sh
# Build OpenBSD from source according to release(8)

set -eu

ask() {
	printf '%s? [yN]: ' "${1}" 1>&2
	read REPLY
	[ "${REPLY}" = y ]
}

_build() {
	exec 1>/dev/null
	set -x
	doas mount -s /usr/${X}obj
	time ${DOAS} make -C"${DIR}" -s ${@}
}

build_base() {
	DIR=/usr/src
	_build obj
	DOAS=doas
	_build -j4 build
	if ask 'run sysmerge'; then
		if ask '  diff mode'; then
			sysmerge -d
		else
			sysmerge
		fi
	fi
	if ask 'create device nodes'; then
		cd /dev && doas ./MAKEDEV all
	fi
}

build_kernel() {
	DIR=/sys/arch/"$(machine)"/compile/GENERIC.MP
	_build obj
	_build config
	_build -j4
	if ask 'install kernel'; then
		DOAS=doas
		_build install
	fi
}

build_xenocara() {
	DIR=/usr/xenocara
	X=x
	_build bootstrap
	_build obj
	DOAS=doas
	_build -j4 build
}

for p in kernel base xenocara; do
	ask "build ${p}" && eval build_${p}
done

return 0
